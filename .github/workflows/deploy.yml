name: Deploy to AWS

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to EC2
        env:
          AWS_ACCESS_KEY_ID: ${{ secrets.AWS_ACCESS_KEY_ID }}
          AWS_SECRET_ACCESS_KEY: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          AWS_REGION: us-east-1
          INSTANCE_ID: i-0df3ff5363c6514f5
        run: |
          # Install AWS CLI
          pip install awscli
          
          # Send deployment command via SSM
          COMMAND_ID=$(aws ssm send-command \
            --instance-ids $INSTANCE_ID \
            --document-name "AWS-RunShellScript" \
            --parameters 'commands=[
              "echo \"ðŸš€ GitHub deployment triggered at $(date)\"",
              "cd /home/ubuntu/ChainViz",
              "git fetch origin",
              "git reset --hard origin/main",
              "echo",
              "echo \"ðŸ“¦ Rebuilding containers...\"",
              "sudo docker-compose build --no-cache",
              "sudo docker-compose up -d",
              "sleep 15",
              "echo",
              "echo \"âœ… Deployment complete!\"",
              "sudo docker-compose ps"
            ]' \
            --timeout-seconds 900 \
            --region $AWS_REGION \
            --query 'Command.CommandId' \
            --output text)
          
          echo "Deployment command sent: $COMMAND_ID"
          echo "Waiting 60 seconds for deployment to start..."
          sleep 60
          
          # Check deployment status
          aws ssm get-command-invocation \
            --command-id $COMMAND_ID \
            --instance-id $INSTANCE_ID \
            --region $AWS_REGION \
            --query 'Status' \
            --output text

